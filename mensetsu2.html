<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>面接予約（1週間・30分枠）</title>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#111827;       /* gray-900 */
      --muted:#ffffff;       /* white (was slate-400) */
      --text:#ffffff;        /* white (was gray-200) */
      --accent:#22c55e;      /* green-500 */
      --accent-2:#3b82f6;    /* blue-500 */
      --danger:#ef4444;      /* red-500 */
      --warn:#f59e0b;        /* amber-500 */
      --card:#0b1224;        /* custom */
      --border: #1f2937;     /* gray-800 */
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0a0f1a);color:var(--text);font:16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "BIZ UDPGothic", Meiryo, sans-serif}
    .app{max-width:1100px;margin:32px auto;padding:0 16px}

    header{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;margin-bottom:16px
    }
    .title{font-weight:700;font-size:clamp(18px,2.8vw,24px)}
    .sub{color:var(--muted);font-size:13px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button,.btn{appearance:none;border:1px solid var(--border);background:#0a1222;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s;box-shadow:var(--shadow)}
    button:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .btn-accent{background:linear-gradient(135deg,var(--accent-2),#60a5fa);border-color:transparent}
    .btn-ghost{background:transparent;border-color:var(--border)}
    .btn-danger{background:linear-gradient(135deg,#ef444480,#ef4444);border-color:transparent}

    .panel{background:linear-gradient(180deg,#0e162c,#0c1426);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}

    /* Week nav */
    .weekbar{display:flex;align-items:center;gap:8px}
    .weeklabel{font-weight:700}

    /* Calendar grid */
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{position:relative;background:radial-gradient(120% 120% at 100% 0%, #0f1a33 0%, #0b1326 60%, #091224 100%);border:1px solid var(--border);border-radius:14px;min-height:130px;padding:10px;cursor:pointer;transition:.15s}
    .day:hover{transform:translateY(-2px)}
    .day.disabled{opacity:.5;pointer-events:none}
    .day .dow{font-size:12px;color:var(--muted)}
    .day .date{font-weight:700;margin-bottom:8px}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0a1326;color:#ffffff} 
    .chip.free{border-color:#1f6feb;background:#0b1833}
    .chip.booked{border-color:#124e2e;background:#0d1f17}

    /* Legend */
    .legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:13px;margin:10px 0 18px}
    .legend .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
    .dot.free{background:var(--accent-2)}
    .dot.booked{background:var(--accent)}

    /* Dialogs */
    dialog{border:none;border-radius:18px;padding:0;background:transparent}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal{background:linear-gradient(180deg,#0e172a,#0b1426);border:1px solid var(--border);border-radius:18px;min-width:min(92vw,720px);max-width:92vw;box-shadow:var(--shadow)}
    .modal header{padding:16px 20px;border-bottom:1px solid var(--border)}
    .modal main{padding:16px 20px}
    .modal footer{display:flex;gap:8px;justify-content:flex-end;padding:16px 20px;border-top:1px solid var(--border)}

    .slots{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .slot{padding:10px;border:1px solid var(--border);border-radius:12px;text-align:center;background:#0b1833;cursor:pointer}
    .slot:hover{filter:brightness(1.05)}
    .slot.booked{background:#0d1f17;border-color:#124e2e;color:#ffffff; text-shadow:0 1px 2px rgba(0,0,0,.35);cursor:not-allowed;pointer-events:none}
    .slot.none{opacity:.6}

    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .stack{display:grid;gap:10px}
    .grid2{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    label{font-size:13px;color:var(--muted)}
    input[type="time"],input[type="text"],input[type="password"],select,textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0a1222;color:var(--text);outline:none
    }
    .range-row{display:flex;gap:8px;align-items:end}
    .range-row > div{flex:1}
    .small{font-size:12px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .divider{height:1px;background:var(--border);margin:12px 0}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:#0a1222;font-size:12px}
    .danger{color:#fecaca}
    .warning{color:#fde68a}

    .footer-note{margin-top:16px;color:var(--muted);font-size:12px}
    .right{margin-left:auto}
  /* 強調：選択中のスロットの見やすさ改善 */
    .slot.selected{
      background: linear-gradient(135deg, var(--accent-2), #60a5fa);
      border-color: transparent;
      color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35); /* 選択後の文字色を濃色にして視認性UP */
      font-weight:700;
    }
  /* 高コントラスト：placeholder も明るい色に */
    input::placeholder, textarea::placeholder{color:#ffffff; opacity:.85}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title">面接予約カレンダー（1週間 / 30分枠）</div>
        <div class="sub">日付をクリック→空き時間を選択→名前を入力</div>
      </div>
      <div class="toolbar">
        <div class="weekbar">
          <button id="prevWeek">◀ 前の週</button>
          <button id="thisWeek" class="btn-ghost">今週</button>
          <button id="nextWeek">次の週 ▶</button>
        </div>
        <span class="weeklabel" id="weekLabel"></span>
        <button id="openAdmin" class="btn-accent">管理者モード</button>
      </div>
    </header>

    <div class="legend">
      <span class="badge"><span class="dot free"></span>予約枠あり</span>
      <span class="badge"><span class="dot booked"></span>予約あり</span>
      <span class="badge warning">30分単位 / 同一枠は1名</span>
    </div>

    <section class="calendar" id="calendar"></section>

    <p class="footer-note">※ このHTML単体では各端末のブラウザに保存します（<strong>複数端末間で自動同期はされません</strong>）。学年全体で共有する場合は、Google スプレッドシート / Firebase 等の連携が必要です（下部の「エクスポート/インポート」で手動同期は可能）。</p>
  </div>

  <!-- 予約ダイアログ -->
  <dialog id="bookingDialog">
    <div class="modal">
      <header>
        <div class="title" id="bookingTitle">予約</div>
        <div class="sub" id="bookingSub"></div>
      </header>
      <main>
        <div id="slotArea" class="slots"></div>
        <div id="inputArea" class="stack" style="margin-top:14px;display:none">
          <div class="grid2">
            <div>
              <label>氏名（フルネーム推奨）</label>
              <input id="studentName" type="text" placeholder="例：山田 太郎" />
              <div class="hint">入力後「予約を確定」を押してください。</div>
            </div>
          </div>
        </div>
      </main>
      <footer>
        <span class="small right" id="bookingHint"></span>
        <button id="closeBooking" class="btn">閉じる</button>
        <button id="confirmBooking" class="btn-accent" disabled>予約を確定</button>
      </footer>
    </div>
  </dialog>

  <!-- 管理者ダイアログ -->
  <dialog id="adminDialog">
    <div class="modal">
      <header style="justify-content:space-between">
        <div>
          <div class="title">管理者モード</div>
          <div class="sub">週ごとの予約枠（時間帯）を設定・編集 / データ入出力</div>
        </div>
        <button id="closeAdmin" class="btn">閉じる</button>
      </header>
      <main>
        <div id="adminGate" class="stack">
          <label>パスコード</label>
          <div class="grid2">
            <input id="adminPass" type="password" placeholder="パスコードを入力" />
            <button id="unlockAdmin" class="btn-accent">開く</button>
          </div>
          <div class="hint">※ 簡易ロックです。機密用途では使わないでください。</div>
        </div>

        <div id="adminBody" style="display:none" class="stack">
          <div class="inline" style="justify-content:space-between">
            <div class="inline" style="gap:6px">
              <button id="adminPrev" class="btn-ghost">◀</button>
              <strong id="adminWeekLabel"></strong>
              <button id="adminNext" class="btn-ghost">▶</button>
              <button id="adminThis" class="btn-ghost">今週</button>
            </div>
            <div class="inline">
              <button id="exportBtn" class="btn-ghost">エクスポート</button>
              <button id="importBtn" class="btn-ghost">インポート</button>
              <input id="importFile" type="file" accept="application/json" style="display:none" />
              <button id="clearWeek" class="btn-danger">この週の予約を全消去</button>
            </div>
          </div>

          <div id="adminDays" class="stack"></div>
        </div>
      </main>
      <footer>
        <span class="small">保存は自動（この端末のブラウザに保存）</span>
      </footer>
    </div>
  </dialog>

  <script>
  /******************** ユーティリティ ********************/
  const PASSCODE = 'homeroom2025'; // 管理者モードの簡易パス
  const SLOT_MINUTES = 30;         // 30分枠
  const STORAGE_KEY = 'homeroom_booking_v1';

  const jpDow = ['日','月','火','水','木','金','土'];

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  const pad2 = n => String(n).padStart(2,'0');

  function toDateKey(d){ // YYYY-MM-DD （ローカルTZ）
    const y = d.getFullYear();
    const m = d.getMonth()+1;
    const da = d.getDate();
    return `${y}-${pad2(m)}-${pad2(da)}`;
  }
  function fromDateKey(key){
    const [y,m,d] = key.split('-').map(Number);
    return new Date(y, m-1, d);
  }

  function weekStart(date){ // 週は月曜はじまり
    const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1 - day); // 月曜:1, 日曜:0
    d.setDate(d.getDate()+diff);
    d.setHours(0,0,0,0);
    return d;
  }
  function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function addWeeks(d, n){ return addDays(d, n*7); }

  function fmtWeekRange(start){
    const end = addDays(start,6);
    return `${start.getFullYear()}/${pad2(start.getMonth()+1)}/${pad2(start.getDate())} 〜 ${end.getFullYear()}/${pad2(end.getMonth()+1)}/${pad2(end.getDate())}`;
  }

  function parseHHMM(s){ const [h,m]=s.split(':').map(Number); return h*60+m; }
  function minutesToHHMM(min){ const h=Math.floor(min/60), m=min%60; return `${pad2(h)}:${pad2(m)}`; }

  function slotTimes(startHHMM, endHHMM){ // ["13:00","13:30",...] endは含まない
    const out=[]; let cur=parseHHMM(startHHMM); const end=parseHHMM(endHHMM);
    while(cur<end){ out.push(minutesToHHMM(cur)); cur+=SLOT_MINUTES; }
    return out;
  }

  /******************** ストレージ ********************/
  const store = {
    load(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch{ return {}; }
    },
    save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); },
    getWeek(weekStartKey){
      const data=this.load();
      return data[weekStartKey] || { availability:{}, bookings:{} };
    },
    setWeek(weekStartKey, obj){
      const data=this.load();
      data[weekStartKey]=obj;
      this.save(data);
    },
    exportAll(){ return JSON.stringify(this.load(), null, 2); },
    importAll(json){ try{ const o=JSON.parse(json); this.save(o); return true; }catch{ return false; } }
  };

  /******************** アプリ状態 ********************/
  let currentWeekStart = weekStart(new Date());
  let selectedDateKey = null;
  let selectedTime = null;

  function getWeekKey(d = currentWeekStart){ return toDateKey(d); }

  function getWeekData(){ return store.getWeek(getWeekKey()); }

  /******************** カレンダー描画 ********************/
  function render(){
    $('#weekLabel').textContent = fmtWeekRange(currentWeekStart);
    const cal = $('#calendar');
    cal.innerHTML='';
    const data = getWeekData();

    for(let i=0;i<7;i++){
      const date = addDays(currentWeekStart,i);
      const key = toDateKey(date);
      const dow = jpDow[date.getDay()];
      const dayEl = document.createElement('div');
      dayEl.className='day panel';
      dayEl.dataset.date = key;

      const title = document.createElement('div');
      title.innerHTML = `<div class="dow">${dow}曜</div><div class="date">${date.getMonth()+1}/${date.getDate()}</div>`;
      dayEl.appendChild(title);

      const chips = document.createElement('div');
      chips.className='chips';

      const ranges = (data.availability[key]||[]);
      const bookings = (data.bookings[key]||{});

      if(ranges.length){
        const chip = document.createElement('span');
        chip.className='chip free';
        const totalSlots = ranges.map(r => slotTimes(r.start, r.end).length).reduce((a,b)=>a+b,0);
        const bookedCount = Object.keys(bookings).length;
        const rest = totalSlots - bookedCount;
        chip.textContent = `枠: 残り${Math.max(rest,0)} / 合計${totalSlots}`;
        chips.appendChild(chip);
      } else {
        const chip = document.createElement('span');
        chip.className='chip';
        chip.textContent='予約枠なし';
        chips.appendChild(chip);
      }

      // 予約者のミニ表示（最大3名、時間付き）
      const pairs = Object.entries(bookings).sort(([t1],[t2])=>t1.localeCompare(t2)).slice(0,3);
      if(pairs.length){
        const chip = document.createElement('span');
        chip.className='chip booked';
        const label = pairs.map(([t,b])=>`${t} ${b.name}`).join('、');
        chip.textContent = `予約: ${Object.keys(bookings).sort().slice(0,3).map(t=>`${t} ${bookings[t].name}`).join('、')}${Object.keys(bookings).length>3?' 他':''}`;
        chips.appendChild(chip);
      }

      dayEl.appendChild(chips);

      dayEl.addEventListener('click',()=>openBooking(key));
      cal.appendChild(dayEl);
    }
  }

  /******************** 予約フロー ********************/
  function openBooking(dateKey){
    selectedDateKey = dateKey;
    selectedTime = null;
    const d = fromDateKey(dateKey);
    $('#bookingTitle').textContent = `${d.getMonth()+1}/${d.getDate()}（${jpDow[d.getDay()]}）の予約`;
    $('#bookingSub').textContent = '空き時間を1つ選択 → 氏名を入力してください。';
    $('#studentName').value='';
    $('#confirmBooking').disabled = true;

    const wkKey = toDateKey(weekStart(fromDateKey(dateKey)));
    const wkData = store.getWeek(wkKey);
    const ranges = (wkData.availability[dateKey] || []);
    const bookings = (wkData.bookings[dateKey] || {});
    const slotArea = $('#slotArea');
    slotArea.innerHTML='';

    if(!ranges.length){
      const div=document.createElement('div');
      div.className='slot none';
      div.textContent='この日は予約枠がありません';
      slotArea.appendChild(div);
    } else {
      const allSlots = ranges.flatMap(r => slotTimes(r.start, r.end).map(t=>({t, range:r})));
      if(!allSlots.length){
        const div=document.createElement('div');
        div.className='slot none';
        div.textContent='設定された時間帯に30分枠が作れませんでした';
        slotArea.appendChild(div);
      }
      allSlots.forEach(({t})=>{
        const booked = bookings[`${t}`];
        const el = document.createElement('div');
        el.className='slot'+(booked?' booked':'');
        el.textContent = booked ? `${t}｜${booked.name}` : t;
        if(!booked){
          el.addEventListener('click',()=>{
            selectedTime = t;
            $$('.slot').forEach(s=>s.style.outline='none');
            el.style.outline='2px solid var(--accent-2)'; $$('.slot').forEach(s=>s.classList.remove('selected')); el.classList.add('selected');
            $('#inputArea').style.display='grid';
            $('#confirmBooking').disabled=false;
            $('#bookingHint').textContent = `選択中: ${t}`;
          });
        }
        slotArea.appendChild(el);
      });
    }
    $('#bookingDialog').showModal();
  }

  function confirmBooking(){
    const name = $('#studentName').value.trim();
    if(!selectedDateKey || !selectedTime){ alert('時間を選択してください'); return; }
    if(!name){ alert('氏名を入力してください'); return; }

    const wkKey = toDateKey(weekStart(fromDateKey(selectedDateKey)));
    const data = store.getWeek(wkKey);
    data.bookings[selectedDateKey] = data.bookings[selectedDateKey] || {};
    if(data.bookings[selectedDateKey][selectedTime]){ alert('既にその時間は予約されています'); render(); return; }
    data.bookings[selectedDateKey][selectedTime] = { name, ts: Date.now() };
    store.setWeek(wkKey, data);

    $('#bookingDialog').close();
    render();
    setTimeout(()=>alert(`予約を受け付けました\n${selectedDateKey} ${selectedTime} / ${name}`), 0);
  }

  /******************** 管理者（可用時間の編集） ********************/
  function openAdmin(){ $('#adminDialog').showModal(); }

  function unlockAdmin(){
    const v = $('#adminPass').value;
    if(v === PASSCODE){
      $('#adminGate').style.display='none';
      $('#adminBody').style.display='grid';
      renderAdmin();
    } else {
      alert('パスコードが違います');
    }
  }

  function renderAdmin(){
    $('#adminWeekLabel').textContent = fmtWeekRange(currentWeekStart);
    const wrap = $('#adminDays');
    wrap.innerHTML='';
    const data = getWeekData();

    for(let i=0;i<7;i++){
      const date = addDays(currentWeekStart,i);
      const key = toDateKey(date);
      const dow = jpDow[date.getDay()];
      const ranges = data.availability[key] || [];
      const bookings = data.bookings[key] || {};

      const card = document.createElement('div');
      card.className='panel';
      card.style.padding='14px';

      const head = document.createElement('div');
      head.className='inline'; head.style.justifyContent='space-between';
      head.innerHTML = `<div><strong>${date.getMonth()+1}/${date.getDate()}（${dow}）</strong></div>`;

      const badges = document.createElement('div');
      const b1 = document.createElement('span');
      b1.className='badge';
      b1.textContent = `予約枠 ${ranges.length? 'あり' : 'なし'}`;
      const b2 = document.createElement('span');
      b2.className='badge';
      b2.textContent = `予約数 ${Object.keys(bookings).length}`;
      const badgeWrap = document.createElement('div');
      badgeWrap.className='inline';
      badgeWrap.appendChild(b1); badgeWrap.appendChild(b2);
      head.appendChild(badgeWrap);

      const list = document.createElement('div');
      list.className='stack'; list.style.marginTop='10px';

      function addRangeRow(range, idx){
        const row = document.createElement('div');
        row.className='range-row';
        row.innerHTML = `
          <div>
            <label>開始</label>
            <input type="time" step="1800" value="${range.start}" data-k="${key}" data-i="${idx}" data-f="start" />
          </div>
          <div>
            <label>終了</label>
            <input type="time" step="1800" value="${range.end}" data-k="${key}" data-i="${idx}" data-f="end" />
          </div>
          <div style="flex:0 0 auto">
            <button class="btn-ghost" data-del="${idx}" data-k="${key}">削除</button>
          </div>`;
        list.appendChild(row);
      }

      if(!ranges.length){
        const none = document.createElement('div');
        none.className='hint';
        none.textContent = '予約枠なし。「＋枠を追加」で時間帯を設定してください（30分単位）。';
        list.appendChild(none);
      } else {
        ranges.forEach((r,idx)=>addRangeRow(r, idx));
      }

      const addBtn = document.createElement('button');
      addBtn.textContent='＋ 枠を追加（例：13:00〜17:00）';
      addBtn.className='btn-ghost';
      addBtn.addEventListener('click',()=>{
        const d = store.getWeek(getWeekKey());
        d.availability[key] = d.availability[key] || [];
        d.availability[key].push({start:'13:00', end:'17:00'});
        store.setWeek(getWeekKey(), d);
        renderAdmin();
      });

      const div = document.createElement('div');
      div.appendChild(head);
      div.appendChild(list);
      div.appendChild(addBtn);

      card.appendChild(div);
      wrap.appendChild(card);
    }

    // 入力・削除のイベント委譲
    wrap.oninput = (e)=>{
      const t = e.target;
      if(t.matches('input[type="time"]')){
        const k = t.dataset.k, i = Number(t.dataset.i), f=t.dataset.f;
        const d = store.getWeek(getWeekKey());
        d.availability[k][i][f] = t.value;
        // 開始>=終了 の場合は自動調整
        const st = parseHHMM(d.availability[k][i].start);
        const en = parseHHMM(d.availability[k][i].end);
        if(en<=st){ d.availability[k][i].end = minutesToHHMM(st + SLOT_MINUTES); t.value = d.availability[k][i][f]; }
        store.setWeek(getWeekKey(), d);
        render();
      }
    };
    wrap.onclick = (e)=>{
      const t = e.target;
      if(t.matches('button[data-del]')){
        const idx = Number(t.dataset.del), k = t.dataset.k;
        const d = store.getWeek(getWeekKey());
        d.availability[k].splice(idx,1);
        store.setWeek(getWeekKey(), d);
        renderAdmin();
        render();
      }
    };
  }

  function clearWeek(){
    if(!confirm('この週の予約をすべて削除します。よろしいですか？')) return;
    const d = getWeekData();
    d.bookings = {};
    store.setWeek(getWeekKey(), d);
    render();
    renderAdmin();
  }

  /******************** エクスポート / インポート ********************/
  function exportAll(){
    const blob = new Blob([store.exportAll()], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const ts = new Date();
    a.href=url; a.download=`homeroom-reservations-${ts.getFullYear()}${pad2(ts.getMonth()+1)}${pad2(ts.getDate())}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function importAll(){ $('#importFile').click(); }
  function handleImport(file){
    const reader = new FileReader();
    reader.onload = e => {
      const ok = store.importAll(e.target.result);
      alert(ok? '読み込みました' : 'JSONの形式が不正です');
      render();
      if($('#adminBody').style.display!=='none') renderAdmin();
    };
    reader.readAsText(file);
  }

  /******************** イベント登録 ********************/
  $('#prevWeek').onclick = ()=>{ currentWeekStart = addWeeks(currentWeekStart,-1); render(); };
  $('#nextWeek').onclick = ()=>{ currentWeekStart = addWeeks(currentWeekStart, 1); render(); };
  $('#thisWeek').onclick = ()=>{ currentWeekStart = weekStart(new Date()); render(); };

  $('#openAdmin').onclick = openAdmin;
  $('#closeAdmin').onclick = ()=>$('#adminDialog').close();
  $('#unlockAdmin').onclick = unlockAdmin;
  $('#adminPrev').onclick = ()=>{ currentWeekStart = addWeeks(currentWeekStart,-1); renderAdmin(); };
  $('#adminNext').onclick = ()=>{ currentWeekStart = addWeeks(currentWeekStart, 1); renderAdmin(); };
  $('#adminThis').onclick = ()=>{ currentWeekStart = weekStart(new Date()); renderAdmin(); };
  $('#clearWeek').onclick = clearWeek;
  $('#exportBtn').onclick = exportAll;
  $('#importBtn').onclick = importAll;
  $('#importFile').addEventListener('change', (e)=>{ if(e.target.files[0]) handleImport(e.target.files[0]); });

  $('#confirmBooking').onclick = confirmBooking;
  $('#closeBooking').onclick = ()=>$('#bookingDialog').close();

  // 初回レンダリング
  render();

  // 初期サンプル（初回のみ）
  (function seed(){
    const all = store.load();
    const key = getWeekKey();
    if(!all[key]){
      all[key] = {
        availability: {},
        bookings: {}
      };
      // 平日 15:30-18:00 を例で投入
      for(let i=0;i<5;i++){
        const d = toDateKey(addDays(currentWeekStart,i+0));
        all[key].availability[d] = [{start:'15:30', end:'18:00'}];
      }
      store.save(all);
      render();
    }
  })();
  </script>
  <script>
  // --- 予約確定の保存先週キーを選択日から算出するように上書き（再選択で空きに戻る問題の修正）---
  (function(){
    window.confirmBooking = function(){
      const name = document.querySelector('#studentName').value.trim();
      if(!selectedDateKey || !selectedTime){ alert('時間を選択してください'); return; }
      if(!name){ alert('氏名を入力してください'); return; }
      // 選択した日付の属する週キーで保存
      const wkKey = toDateKey(weekStart(fromDateKey(selectedDateKey)));
      const data = store.getWeek(wkKey);
      data.bookings[selectedDateKey] = data.bookings[selectedDateKey] || {};
      if(data.bookings[selectedDateKey][selectedTime]){ alert('他の人に予約されました'); render(); return; }
      data.bookings[selectedDateKey][selectedTime] = { name, ts: Date.now() };
      store.setWeek(wkKey, data);

      document.querySelector('#bookingDialog').close();
      render();
      setTimeout(()=>alert(`予約を受け付けました
${selectedDateKey} ${selectedTime} / ${name}`), 0);
    };
    // ボタンのハンドラを上書き関数に再バインド
    const btn = document.querySelector('#confirmBooking');
    if(btn) btn.onclick = window.confirmBooking;
  })();
  </script>
</body>
</html>
